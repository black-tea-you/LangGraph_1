<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Vibe Coding Test - ì›¹ ì¸í„°í˜ì´ìŠ¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: grid;
            grid-template-columns: 1fr 400px;
            height: calc(100vh - 40px);
        }

        .main-panel {
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e0e0e0;
            height: 100%;
            overflow: hidden;
        }

        .header {
            padding: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex-shrink: 0;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .header .session-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .token-usage {
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            font-size: 13px;
        }

        .token-usage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .token-usage-label {
            font-weight: 600;
        }

        .token-usage-value {
            font-weight: 700;
        }

        .token-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .token-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80 0%, #fbbf24 70%, #ef4444 90%);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .token-details {
            margin-top: 8px;
            font-size: 11px;
            opacity: 0.85;
            display: flex;
            justify-content: space-between;
        }

        .token-warning {
            color: #fbbf24;
        }

        .token-danger {
            color: #ef4444;
        }

        .problem-toggle {
            position: absolute;
            top: 24px;
            left: 24px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            z-index: 10;
        }

        .problem-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .problem-panel {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            color: #333;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }

        .problem-panel.open {
            max-height: 500px;
            overflow-y: auto;
        }

        .problem-content {
            padding: 24px;
        }

        .problem-content h2 {
            color: #667eea;
            margin-bottom: 16px;
            font-size: 20px;
        }

        .problem-content h3 {
            color: #764ba2;
            margin-top: 20px;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .problem-content p {
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .problem-content .info-section {
            background: #f5f5f5;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .problem-content .info-section strong {
            color: #667eea;
        }

        .problem-content ul {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .problem-content li {
            margin-bottom: 8px;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            background: #f5f5f5;
            min-height: 200px;
            max-height: calc(100vh - 300px);
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.assistant {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .message.user .message-bubble {
            background: #667eea;
            color: white;
        }

        .message.assistant .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            padding: 0 4px;
        }

        .resizer {
            height: 4px;
            background: #e0e0e0;
            cursor: ns-resize;
            position: relative;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .resizer:hover {
            background: #667eea;
        }

        .resizer::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 4px;
            background: #ccc;
            border-radius: 2px;
        }

        .resizer:hover::before {
            background: #667eea;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
            min-height: 150px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .input-group {
            display: flex;
            gap: 12px;
        }

        .input-group textarea {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 14px;
            resize: none;
            font-family: inherit;
        }

        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-submit {
            background: #10b981;
            color: white;
        }

        .btn-submit:hover:not(:disabled) {
            background: #059669;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            background: #f9fafb;
            overflow-y: auto;
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .sidebar-section h2 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }

        .turn-log {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #667eea;
        }

        .turn-log h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #667eea;
        }

        .turn-log .score {
            font-size: 18px;
            font-weight: bold;
            color: #10b981;
            margin: 8px 0;
        }

        .turn-log .details {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        .turn-log-content {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            margin-top: 8px;
            padding: 8px;
            background: #f9fafb;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .turn-log-toggle {
            background: #667eea;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-top: 8px;
        }

        .turn-log-toggle:hover {
            background: #5568d3;
        }

        .code-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            min-height: 200px;
        }

        .code-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .final-scores {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 12px;
        }

        .final-scores h3 {
            margin-bottom: 12px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .score-item.total {
            font-size: 20px;
            font-weight: bold;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }

        .detail-section {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .detail-section h4 {
            margin-bottom: 12px;
            font-size: 14px;
            opacity: 0.9;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 13px;
            opacity: 0.9;
        }

        .detail-item.warning {
            color: #fef3c7;
            font-weight: bold;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .refresh-btn {
            background: #f3f4f6;
            color: #333;
            padding: 8px 16px;
            font-size: 12px;
            margin-top: 8px;
        }

        .refresh-btn:hover {
            background: #e5e7eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-panel">
            <div class="header">
                <button class="problem-toggle" id="problemToggle" onclick="toggleProblemPanel()">
                    ğŸ“‹ ë¬¸ì œ ë³´ê¸°
                </button>
                <h1>ğŸ¤– AI Vibe Coding Test</h1>
                <div class="session-info">
                    Session: <span id="sessionId">-</span> | Turn: <span id="currentTurn">0</span>
                </div>
                <div class="token-usage">
                    <div class="token-usage-header">
                        <span class="token-usage-label">í† í° ì‚¬ìš©ëŸ‰</span>
                        <span class="token-usage-value" id="tokenUsageValue">0 / 20,000</span>
                    </div>
                    <div class="token-progress-bar">
                        <div class="token-progress-fill" id="tokenProgressFill" style="width: 0%;"></div>
                    </div>
                    <div class="token-details">
                        <span>ì±„íŒ…: <span id="chatTokens">0</span></span>
                        <span>í‰ê°€: <span id="evalTokens">0</span></span>
                    </div>
                </div>
                <div class="problem-panel" id="problemPanel">
                    <div class="problem-content" id="problemContent">
                        <p>ë¬¸ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="message assistant">
                    <div class="message-bubble">
                        ì•ˆë…•í•˜ì„¸ìš”! AI ì½”ë”© ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. ë¬¸ì œ í•´ê²°ì„ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.
                    </div>
                    <div class="message-time">ì‹œì‘</div>
                </div>
            </div>

            <div class="resizer" id="resizer"></div>

            <div class="input-area" id="inputArea">
                <div class="input-group">
                    <textarea 
                        id="messageInput" 
                        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                        rows="2"
                        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                    ></textarea>
                    <button class="btn btn-primary" id="sendBtn" onclick="sendMessage()">ì „ì†¡</button>
                </div>
                <div style="margin-top: 12px; display: flex; gap: 8px;">
                    <textarea 
                        id="codeInput" 
                        class="code-input"
                        placeholder="ì½”ë“œ ì œì¶œ (ì„ íƒì‚¬í•­)"
                    ></textarea>
                </div>
                <div style="margin-top: 8px;">
                    <button class="btn btn-submit" id="submitBtn" onclick="submitCode()">ì½”ë“œ ì œì¶œ</button>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-section">
                <h2>ğŸ“Š ë°±ê·¸ë¼ìš´ë“œ í‰ê°€</h2>
                <button class="btn refresh-btn" onclick="refreshTurnLogs()">ìƒˆë¡œê³ ì¹¨</button>
                <div id="turnLogs">
                    <div style="color: #999; font-size: 14px; margin-top: 12px;">í‰ê°€ ëŒ€ê¸° ì¤‘...</div>
                </div>
            </div>

            <div class="sidebar-section" id="finalScoresSection" style="display: none;">
                <h2>ğŸ† ìµœì¢… ì ìˆ˜</h2>
                <div id="finalScores"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        // í…ŒìŠ¤íŠ¸ìš© ê¸°ë³¸ê°’ (setup_web_test_data.pyì—ì„œ ìƒì„±í•œ ì„¸ì…˜ ì‚¬ìš©)
        // ì‹¤ì œ í…ŒìŠ¤íŠ¸ ì‹œì—ëŠ” setup_web_test_data.pyë¥¼ ì‹¤í–‰í•˜ì—¬ ìƒì„±ëœ ì„¸ì…˜ IDë¥¼ ì‚¬ìš©í•˜ì„¸ìš”
        let sessionId = 1; // PostgreSQL session_id (ìˆ«ì) - setup_web_test_data.pyì—ì„œ ìƒì„±ëœ ê°’
        let participantId = 1; // participants.id - setup_web_test_data.pyì—ì„œ ìƒì„±ëœ ê°’
        let problemId = 1; // problem_id - setup_web_test_data.pyì—ì„œ ìƒì„±ëœ ê°’
        let specVersion = 10; // spec_id - setup_web_test_data.pyì—ì„œ ìƒì„±ëœ ê°’ (spec_id=10)
        let currentTurn = 0; // í˜„ì¬ í„´ ë²ˆí˜¸ (ì‚¬ìš©ì ë©”ì‹œì§€ í„´)
        let refreshInterval = null;
        let openTurnLogs = new Set(); // ì—´ë ¤ìˆëŠ” í„´ ë¡œê·¸ ID ì €ì¥
        let problemPanelOpen = false;
        
        // í† í° ì‚¬ìš©ëŸ‰ ì¶”ì 
        const TOKEN_LIMIT = 20000; // 20K ì œí•œ
        let totalChatTokens = 0;
        let totalEvalTokens = 0;

        // ì´ˆê¸°í™”
        document.getElementById('sessionId').textContent = `Session ${sessionId}`;
        
        // ë¬¸ì œ ì •ë³´ ë¡œë“œ
        loadProblemInfo();

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            // UI ì—…ë°ì´íŠ¸
            addMessage('user', message);
            input.value = '';
            setLoading(true);

            try {
                // turnIdëŠ” ì‚¬ìš©ì ë©”ì‹œì§€ í„´ ë²ˆí˜¸ (1ë¶€í„° ì‹œì‘)
                const userTurnId = currentTurn + 1;
                
                const response = await fetch(`${API_BASE}/chat/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        participantId: participantId,  // participants.id (API ìŠ¤í‚¤ë§ˆì— ë§ê²Œ ìˆ˜ì •)
                        turnId: userTurnId,
                        role: "USER",
                        content: message,
                        context: {
                            problemId: problemId,
                            specVersion: specVersion
                        }
                    })
                });

                const data = await response.json();

                if (data.error) {
                    addMessage('assistant', `âŒ ì˜¤ë¥˜: ${data.error_message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                } else {
                    if (data.aiMessage && data.aiMessage.content) {
                        addMessage('assistant', data.aiMessage.content);
                    }
                    // AI í„´ ë²ˆí˜¸ ì—…ë°ì´íŠ¸ (ì‚¬ìš©ì í„´ ë‹¤ìŒì´ AI í„´)
                    if (data.aiMessage && data.aiMessage.turn) {
                        currentTurn = data.aiMessage.turn;
                        document.getElementById('currentTurn').textContent = currentTurn;
                    }
                    
                    // í† í° ì‚¬ìš©ëŸ‰ ì—…ë°ì´íŠ¸
                    if (data.aiMessage) {
                        updateTokenUsage({
                            tokenCount: data.aiMessage.tokenCount || 0,
                            totalToken: data.aiMessage.totalToken || 0
                        });
                    }
                }

                // ë°±ê·¸ë¼ìš´ë“œ í‰ê°€ ìƒˆë¡œê³ ì¹¨ (ì•½ê°„ì˜ ì§€ì—° í›„)
                setTimeout(refreshTurnLogs, 2000);
            } catch (error) {
                addMessage('assistant', `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        // ì½”ë“œ ì œì¶œ
        async function submitCode() {
            const codeInput = document.getElementById('codeInput');
            const code = codeInput.value.trim();

            if (!code) {
                alert('ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            setLoading(true);
            addMessage('user', `[ì½”ë“œ ì œì¶œ]\n\`\`\`python\n${code}\n\`\`\``);

            try {
                const response = await fetch(`${API_BASE}/chat/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        exam_id: 1,
                        participant_id: 100,
                        spec_id: 10,
                        code: code,
                        lang: 'python'
                    })
                });

                const data = await response.json();

                if (data.error) {
                    addMessage('assistant', `âŒ ì œì¶œ ì˜¤ë¥˜: ${data.error_message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                } else {
                    // ì œì¶œ ì„±ê³µ ë©”ì‹œì§€
                    let successMsg = 'âœ… ì½”ë“œ ì œì¶œ ì™„ë£Œ! í‰ê°€ê°€ ì§„í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n';
                    
                    if (data.final_scores) {
                        const scores = data.final_scores;
                        successMsg += `ğŸ“Š ìµœì¢… ì ìˆ˜: ${scores.total_score?.toFixed(1) || 0}ì  (ë“±ê¸‰: ${scores.grade || 'N/A'})\n`;
                        
                        // 6ë²ˆ ë…¸ë“œ ìƒì„¸ ì •ë³´
                        if (scores.correctness_details) {
                            const cd = scores.correctness_details;
                            successMsg += `\nğŸ“‹ ì •í™•ì„± í‰ê°€:\n`;
                            successMsg += `  - í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤: ${cd.test_cases_passed || 0}/${cd.test_cases_total || 0} í†µê³¼\n`;
                            successMsg += `  - í†µê³¼ìœ¨: ${cd.pass_rate || 0}%\n`;
                        }
                        
                        if (scores.performance_details) {
                            const pd = scores.performance_details;
                            if (pd.skip_performance) {
                                successMsg += `\nâš¡ ì„±ëŠ¥ í‰ê°€: ê±´ë„ˆëœ€ (${pd.skip_reason || 'Correctness ì‹¤íŒ¨'})\n`;
                            } else {
                                successMsg += `\nâš¡ ì„±ëŠ¥ í‰ê°€:\n`;
                                if (pd.execution_time) {
                                    successMsg += `  - ì‹¤í–‰ ì‹œê°„: ${pd.execution_time.toFixed(3)}ì´ˆ\n`;
                                }
                                if (pd.memory_used_mb) {
                                    successMsg += `  - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: ${pd.memory_used_mb.toFixed(2)}MB\n`;
                                }
                            }
                        }
                    }
                    
                    addMessage('assistant', successMsg);
                    
                    // í† í° ì‚¬ìš©ëŸ‰ ì—…ë°ì´íŠ¸
                    updateTokenUsage(data);
                    
                    // ìµœì¢… ì ìˆ˜ í‘œì‹œ (ìƒì„¸ ì •ë³´ í¬í•¨)
                    if (data.final_scores) {
                        displayFinalScores(data.final_scores);
                    }

                    // í„´ ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
                    setTimeout(refreshTurnLogs, 2000);
                }
            } catch (error) {
                addMessage('assistant', `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        // í„´ ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
        async function refreshTurnLogs() {
            try {
                const response = await fetch(`${API_BASE}/chat/turn-logs?session_id=${sessionId}`);
                const data = await response.json();

                if (data.error) {
                    document.getElementById('turnLogs').innerHTML = 
                        `<div class="error">ì˜¤ë¥˜: ${data.error_message}</div>`;
                    return;
                }

                const logs = data.turn_logs || {};
                const turnNumbers = Object.keys(logs).sort((a, b) => parseInt(a) - parseInt(b));

                if (turnNumbers.length === 0) {
                    document.getElementById('turnLogs').innerHTML = 
                        '<div style="color: #999; font-size: 14px;">í‰ê°€ ëŒ€ê¸° ì¤‘...</div>';
                    return;
                }

                // í˜„ì¬ ì—´ë ¤ìˆëŠ” í„´ ë¡œê·¸ ìƒíƒœ í™•ì¸
                const wasOpen = new Set(openTurnLogs);
                
                let html = '';
                turnNumbers.forEach(turn => {
                    const log = logs[turn];
                    const evalDetails = log.prompt_evaluation_details || {};
                    const score = evalDetails.score || 0;
                    const intent = evalDetails.intent || 'UNKNOWN';
                    const rubrics = evalDetails.rubrics || [];
                    const logId = `turn-log-${turn}`;
                    const contentId = `turn-content-${turn}`;

                    // ì „ì²´ ë¡œê·¸ë¥¼ JSONìœ¼ë¡œ í¬ë§·íŒ…
                    const fullLogJson = JSON.stringify(log, null, 2);

                    // ì´ì „ì— ì—´ë ¤ìˆì—ˆëŠ”ì§€ í™•ì¸
                    const isOpen = wasOpen.has(contentId);
                    const displayStyle = isOpen ? 'block' : 'none';
                    const buttonText = isOpen ? 'ìƒì„¸ ë‚´ìš© ìˆ¨ê¸°ê¸°' : 'ìƒì„¸ ë‚´ìš© ë³´ê¸°';

                    html += `
                        <div class="turn-log">
                            <h3>Turn ${turn}</h3>
                            <div class="score">ì ìˆ˜: ${score.toFixed(1)}</div>
                            <div class="details">
                                <div>ì˜ë„: ${intent}</div>
                                <div>í‰ê°€ í•­ëª©: ${rubrics.length}ê°œ</div>
                            </div>
                            <button class="turn-log-toggle" onclick="toggleTurnLog('${contentId}')">
                                ${buttonText}
                            </button>
                            <div id="${contentId}" class="turn-log-content" style="display: ${displayStyle};">
${escapeHtml(fullLogJson)}
                            </div>
                        </div>
                    `;
                });

                document.getElementById('turnLogs').innerHTML = html;
            } catch (error) {
                document.getElementById('turnLogs').innerHTML = 
                    `<div class="error">ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        // ìµœì¢… ì ìˆ˜ í‘œì‹œ (6ë²ˆ ë…¸ë“œ ìƒì„¸ ì •ë³´ í¬í•¨)
        function displayFinalScores(scores) {
            const section = document.getElementById('finalScoresSection');
            const container = document.getElementById('finalScores');

            section.style.display = 'block';

            // Correctness ìƒì„¸ ì •ë³´
            let correctnessDetails = '';
            if (scores.correctness_details) {
                const cd = scores.correctness_details;
                correctnessDetails = `
                    <div class="detail-section">
                        <h4>ğŸ“Š ì •í™•ì„± í‰ê°€ ìƒì„¸</h4>
                        <div class="detail-item">
                            <span>í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ í†µê³¼</span>
                            <span>${cd.test_cases_passed || 0} / ${cd.test_cases_total || 0}</span>
                        </div>
                        <div class="detail-item">
                            <span>í†µê³¼ìœ¨</span>
                            <span>${cd.pass_rate || 0}%</span>
                        </div>
                    </div>
                `;
            }

            // Performance ìƒì„¸ ì •ë³´
            let performanceDetails = '';
            if (scores.performance_details) {
                const pd = scores.performance_details;
                if (pd.skip_performance) {
                    performanceDetails = `
                        <div class="detail-section">
                            <h4>âš¡ ì„±ëŠ¥ í‰ê°€</h4>
                            <div class="detail-item warning">
                                <span>í‰ê°€ ê±´ë„ˆëœ€</span>
                                <span>${pd.skip_reason || 'Correctness ì‹¤íŒ¨'}</span>
                            </div>
                        </div>
                    `;
                } else {
                    performanceDetails = `
                        <div class="detail-section">
                            <h4>âš¡ ì„±ëŠ¥ í‰ê°€ ìƒì„¸</h4>
                            <div class="detail-item">
                                <span>ì‹¤í–‰ ì‹œê°„</span>
                                <span>${pd.execution_time ? pd.execution_time.toFixed(3) + 'ì´ˆ' : 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span>ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰</span>
                                <span>${pd.memory_used_mb ? pd.memory_used_mb.toFixed(2) + 'MB' : 'N/A'}</span>
                            </div>
                        </div>
                    `;
                }
            }

            container.innerHTML = `
                <div class="final-scores">
                    <h3>ìµœì¢… í‰ê°€ ê²°ê³¼</h3>
                    <div class="score-item">
                        <span>í”„ë¡¬í”„íŠ¸ ì ìˆ˜</span>
                        <span>${(scores.prompt_score || 0).toFixed(1)}</span>
                    </div>
                    <div class="score-item">
                        <span>ì„±ëŠ¥ ì ìˆ˜</span>
                        <span>${(scores.performance_score || 0).toFixed(1)}</span>
                    </div>
                    <div class="score-item">
                        <span>ì •í™•ì„± ì ìˆ˜</span>
                        <span>${(scores.correctness_score || 0).toFixed(1)}</span>
                    </div>
                    <div class="score-item total">
                        <span>ì´ì </span>
                        <span>${(scores.total_score || 0).toFixed(1)}</span>
                    </div>
                    <div style="margin-top: 12px; text-align: center; font-size: 18px; font-weight: bold;">
                        ë“±ê¸‰: ${scores.grade || 'N/A'}
                    </div>
                    ${correctnessDetails}
                    ${performanceDetails}
                </div>
            `;
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(role, text) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = text;
            
            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = new Date().toLocaleTimeString('ko-KR');

            messageDiv.appendChild(bubble);
            messageDiv.appendChild(time);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // ë¡œë”© ìƒíƒœ ì„¤ì •
        function setLoading(loading) {
            const sendBtn = document.getElementById('sendBtn');
            const submitBtn = document.getElementById('submitBtn');
            
            sendBtn.disabled = loading;
            submitBtn.disabled = loading;
            
            if (loading) {
                sendBtn.innerHTML = '<span class="loading"></span>';
            } else {
                sendBtn.textContent = 'ì „ì†¡';
            }
        }

        // í„´ ë¡œê·¸ í† ê¸€
        function toggleTurnLog(contentId) {
            const content = document.getElementById(contentId);
            const button = content.previousElementSibling;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.textContent = 'ìƒì„¸ ë‚´ìš© ìˆ¨ê¸°ê¸°';
                openTurnLogs.add(contentId); // ì—´ë¦° ìƒíƒœ ì €ì¥
            } else {
                content.style.display = 'none';
                button.textContent = 'ìƒì„¸ ë‚´ìš© ë³´ê¸°';
                openTurnLogs.delete(contentId); // ë‹«íŒ ìƒíƒœ ì €ì¥
            }
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // í† í° ì‚¬ìš©ëŸ‰ ì—…ë°ì´íŠ¸
        function updateTokenUsage(data) {
            // ìƒˆë¡œìš´ API ì‘ë‹µ í˜•ì‹: tokenCount (í˜„ì¬ í„´), totalToken (ì „ì²´ ëˆ„ì )
            if (data.tokenCount !== undefined) {
                // í˜„ì¬ í„´ì˜ í† í° ì‚¬ìš©ëŸ‰ (ì¶”ê°€)
                // totalTokenì€ ì „ì²´ ëˆ„ì ê°’ì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                if (data.totalToken !== undefined) {
                    totalChatTokens = data.totalToken; // ì „ì²´ ëˆ„ì  í† í°
                }
            }
            
            // eval_tokensëŠ” ë³„ë„ë¡œ ê´€ë¦¬ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ 0ìœ¼ë¡œ ì„¤ì •
            totalEvalTokens = 0;
            
            // ì´ í† í° ì‚¬ìš©ëŸ‰ ê³„ì‚°
            const totalUsed = totalChatTokens + totalEvalTokens;
            const percentage = Math.min((totalUsed / TOKEN_LIMIT) * 100, 100);
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('tokenUsageValue').textContent = 
                `${totalUsed.toLocaleString()} / ${TOKEN_LIMIT.toLocaleString()}`;
            document.getElementById('tokenProgressFill').style.width = `${percentage}%`;
            document.getElementById('chatTokens').textContent = totalChatTokens.toLocaleString();
            document.getElementById('evalTokens').textContent = totalEvalTokens.toLocaleString();
            
            // ê²½ê³  ìƒ‰ìƒ ì ìš©
            const valueElement = document.getElementById('tokenUsageValue');
            const progressFill = document.getElementById('tokenProgressFill');
            
            if (percentage >= 90) {
                valueElement.className = 'token-usage-value token-danger';
                progressFill.style.background = '#ef4444';
            } else if (percentage >= 70) {
                valueElement.className = 'token-usage-value token-warning';
                progressFill.style.background = 'linear-gradient(90deg, #fbbf24 0%, #ef4444 100%)';
            } else {
                valueElement.className = 'token-usage-value';
                progressFill.style.background = 'linear-gradient(90deg, #4ade80 0%, #fbbf24 70%, #ef4444 90%)';
            }
        }

        // ë¦¬ì‚¬ì´ì € ê¸°ëŠ¥
        let isResizing = false;
        let startY = 0;
        let startChatHeight = 0;
        let startInputHeight = 0;

        const resizer = document.getElementById('resizer');
        const chatContainer = document.getElementById('chatContainer');
        const inputArea = document.getElementById('inputArea');

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            startY = e.clientY;
            startChatHeight = chatContainer.offsetHeight;
            startInputHeight = inputArea.offsetHeight;
            document.body.style.cursor = 'ns-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            const deltaY = e.clientY - startY;
            const container = chatContainer.parentElement;
            const containerHeight = container.offsetHeight;
            const headerHeight = container.querySelector('.header').offsetHeight;
            const resizerHeight = resizer.offsetHeight;
            const availableHeight = containerHeight - headerHeight - resizerHeight;

            // ìµœì†Œ/ìµœëŒ€ ë†’ì´ ì œí•œ
            const minChatHeight = 200;
            const minInputHeight = 150;
            const maxChatHeight = availableHeight - minInputHeight;
            const maxInputHeight = availableHeight - minChatHeight;

            let newChatHeight = startChatHeight + deltaY;
            let newInputHeight = startInputHeight - deltaY;

            // ì œí•œ ì ìš©
            if (newChatHeight < minChatHeight) {
                newChatHeight = minChatHeight;
                newInputHeight = availableHeight - minChatHeight;
            } else if (newChatHeight > maxChatHeight) {
                newChatHeight = maxChatHeight;
                newInputHeight = minInputHeight;
            } else if (newInputHeight < minInputHeight) {
                newInputHeight = minInputHeight;
                newChatHeight = availableHeight - minInputHeight;
            } else if (newInputHeight > maxInputHeight) {
                newInputHeight = maxInputHeight;
                newChatHeight = minChatHeight;
            }

            chatContainer.style.height = newChatHeight + 'px';
            chatContainer.style.flex = 'none';
            inputArea.style.height = newInputHeight + 'px';
            inputArea.style.flex = 'none';
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });

        // ë¬¸ì œ íŒ¨ë„ í† ê¸€
        function toggleProblemPanel() {
            const panel = document.getElementById('problemPanel');
            const toggle = document.getElementById('problemToggle');
            problemPanelOpen = !problemPanelOpen;
            
            if (problemPanelOpen) {
                panel.classList.add('open');
                toggle.textContent = 'ğŸ“‹ ë¬¸ì œ ìˆ¨ê¸°ê¸°';
            } else {
                panel.classList.remove('open');
                toggle.textContent = 'ğŸ“‹ ë¬¸ì œ ë³´ê¸°';
            }
        }

        // ë¬¸ì œ ì •ë³´ ë¡œë“œ
        async function loadProblemInfo() {
            try {
                const response = await fetch(`${API_BASE}/chat/problem-info?spec_id=${SPEC_ID}`);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('problemContent').innerHTML = 
                        `<p style="color: red;">ë¬¸ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${data.error_message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>`;
                    return;
                }
                
                const problemInfo = data.problem_info;
                if (!problemInfo) {
                    document.getElementById('problemContent').innerHTML = 
                        '<p>ë¬¸ì œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                
                // ë¬¸ì œ ì •ë³´ í¬ë§·íŒ…
                const basicInfo = problemInfo.basic_info || {};
                const constraints = problemInfo.constraints || {};
                const aiGuide = problemInfo.ai_guide || {};
                
                let html = `
                    <h2>${basicInfo.title || 'ë¬¸ì œ ì œëª©'}</h2>
                    ${basicInfo.problem_id ? `<p><strong>ë¬¸ì œ ë²ˆí˜¸:</strong> ${basicInfo.problem_id}</p>` : ''}
                    
                    <div class="info-section">
                        <h3>ğŸ“ ë¬¸ì œ ì„¤ëª…</h3>
                        <p>${basicInfo.description_summary || 'ì„¤ëª… ì—†ìŒ'}</p>
                    </div>
                    
                    ${basicInfo.input_format ? `
                    <div class="info-section">
                        <h3>ğŸ“¥ ì…ë ¥ í˜•ì‹</h3>
                        <p>${basicInfo.input_format}</p>
                    </div>
                    ` : ''}
                    
                    ${basicInfo.output_format ? `
                    <div class="info-section">
                        <h3>ğŸ“¤ ì¶œë ¥ í˜•ì‹</h3>
                        <p>${basicInfo.output_format}</p>
                    </div>
                    ` : ''}
                    
                    ${constraints.time_limit_sec || constraints.memory_limit_mb ? `
                    <div class="info-section">
                        <h3>â±ï¸ ì œì•½ ì¡°ê±´</h3>
                        ${constraints.time_limit_sec ? `<p><strong>ì‹œê°„ ì œí•œ:</strong> ${constraints.time_limit_sec}ì´ˆ</p>` : ''}
                        ${constraints.memory_limit_mb ? `<p><strong>ë©”ëª¨ë¦¬ ì œí•œ:</strong> ${constraints.memory_limit_mb}MB</p>` : ''}
                        ${constraints.logic_reasoning ? `<p><strong>ì•Œê³ ë¦¬ì¦˜ íŒíŠ¸:</strong> ${constraints.logic_reasoning}</p>` : ''}
                    </div>
                    ` : ''}
                    
                    ${aiGuide.key_algorithms && aiGuide.key_algorithms.length > 0 ? `
                    <div class="info-section">
                        <h3>ğŸ”‘ ì£¼ìš” ì•Œê³ ë¦¬ì¦˜</h3>
                        <ul>
                            ${aiGuide.key_algorithms.map(alg => `<li>${alg}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    ${aiGuide.common_pitfalls && aiGuide.common_pitfalls.length > 0 ? `
                    <div class="info-section">
                        <h3>âš ï¸ ìì£¼ í‹€ë¦¬ëŠ” ì‹¤ìˆ˜</h3>
                        <ul>
                            ${aiGuide.common_pitfalls.map(pitfall => `<li>${pitfall}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                `;
                
                document.getElementById('problemContent').innerHTML = html;
            } catch (error) {
                console.error('ë¬¸ì œ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('problemContent').innerHTML = 
                    `<p style="color: red;">ë¬¸ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
            }
        }

        // ì£¼ê¸°ì ìœ¼ë¡œ í„´ ë¡œê·¸ ìƒˆë¡œê³ ì¹¨ (5ì´ˆë§ˆë‹¤)
        refreshInterval = setInterval(refreshTurnLogs, 5000);

        // ì´ˆê¸° í„´ ë¡œê·¸ ë¡œë“œ
        refreshTurnLogs();
    </script>
</body>
</html>

