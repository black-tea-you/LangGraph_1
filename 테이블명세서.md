AI Vibe Coding Test — ERD 학습용 요약 (Markdown)

본 문서는 AI 학습/임베딩에 최적화되도록, 핵심 엔터티/컬럼/제약/관계를 간결하게 정리했습니다.
스키마: ai_vibe_coding_test (PostgreSQL 14+)

0) 공통 ENUM

difficulty_enum: EASY | MEDIUM | HARD

problem_status_enum: DRAFT | REVIEW | PUBLISHED | ARCHIVED

exam_state_enum: WAITING | RUNNING | ENDED

prompt_role_enum: USER | AI

submission_status_enum: QUEUED | RUNNING | DONE | FAILED

run_grp_enum: SAMPLE | PUBLIC | PRIVATE

verdict_enum: AC | WA | TLE | MLE | RE

evaluation_type_enum: TURN_EVAL | HOLISTIC_FLOW

1) 핵심 개념

문제/스펙 분리: problems(문제 메타) ↔ problem_specs(버전 단위 스펙).
problems.current_spec_id → 현재 채택 스펙(FK).

시험 배정 단위: exam_participants.spec_id 로 세션-스펙 버전 잠금.
대화/제출/채점/평가 모두 이 spec_id를 참조.

채점 파이프라인: submissions → submission_runs → scores.
SSE 이벤트(build/case_end/summary/score)는 submissions 업데이트와 연동.

대화 로그: prompt_sessions(세션) ↔ prompt_messages(turn별 메시지).

운영/감사: entry_codes, admins, admin_audit_logs.

새 통계 테이블(추가): exam_statistics — 시험 단위 시간 버킷 스냅샷.

2) 엔터티별 정의
2.1 admins

PK: id

주요: admin_number(UNIQUE), email, password_hash, role, is_2fa_enabled, is_active

규칙:
- role: ADMIN | MASTER (기본값: ADMIN)
- is_active: 계정 활성 상태 (기본값: true)
- 비활성화된 계정(is_active=false)은 로그인할 수 없음
- 관리자 번호를 비활성화하면 해당 관리자 계정도 자동으로 비활성화됨
- 마스터 계정(role=MASTER)은 비활성화할 수 없음

2.1.a admin_numbers

PK: id

주요: admin_number(UNIQUE), label, is_active, issued_by(FK→admins.id), assigned_admin_id(FK→admins.id), expires_at, used_at

규칙:
- 발급 시 is_active=true, assigned_admin_id=null
- 회원가입 성공 시 assigned_admin_id, used_at 설정 후 is_active=false
- expires_at < now 이거나 is_active=false 이면 사용 불가

감사/변경: created_at, updated_at(트리거)

2.2 participants

PK: id

주요: name, phone(UNIQUE)

생성: created_at

2.3 problems

PK: id

주요: title, difficulty, tags(JSONB), status

현재 스펙: current_spec_id(FK → problem_specs.spec_id) (지연검사)

2.4 problem_specs

PK: spec_id

자연키: UNIQUE(problem_id, version)

FK: problem_id → problems.id

본문/제약: content_md, checker_json, rubric_json, changelog_md, published_at

2.5 problem_sets

PK: id

작성자: created_by(FK → admins.id)

이름/생성시각: name, created_at

2.6 problem_set_items

PK: id

UNIQUE: (problem_set_id, problem_id)

FK: problem_set_id → problem_sets.id, problem_id → problems.id

가중치: weight

2.7 exams

PK: id

상태/시간: state, starts_at, ends_at

브로드캐스트 버전: version

작성자: created_by(FK → admins.id)

타임스탬프: created_at, updated_at(트리거)

2.8 entry_codes

PK: code (문자열)

FK: exam_id → exams.id, problem_set_id → problem_sets.id(NULL 가능), created_by → admins.id

제약: expires_at, max_uses, used_count, is_active, label

2.9 exam_participants

PK: id

UNIQUE: (exam_id, participant_id)

FK: exam_id → exams.id, participant_id → participants.id, spec_id → problem_specs.spec_id

상태/토큰: state, token_limit, token_used

입장시각: joined_at

2.10 prompt_sessions

PK: id

FK (무결성): (exam_id, participant_id) → exam_participants(exam_id, participant_id)

FK: spec_id → problem_specs.spec_id

토큰 합: total_tokens

시간: started_at, ended_at

2.11 prompt_messages

PK: id

UNIQUE: (session_id, turn)

FK: session_id → prompt_sessions.id

역할/내용: role, content, token_count, meta(JSONB)

FTS: fts(tsvector) (GIN 인덱스)

2.11.a prompt_evaluations

PK: id

UNIQUE: (session_id, turn, evaluation_type)

FK: session_id → prompt_sessions.id (ON DELETE CASCADE)

FK (조건부): (session_id, turn) → prompt_messages(session_id, turn) (turn이 NULL이 아닐 때만)

평가 유형: evaluation_type (ENUM: TURN_EVAL, HOLISTIC_FLOW)

턴: turn (NULL이면 세션 전체 평가)

상세 데이터: details (JSONB, NOT NULL) — 모든 평가 데이터 저장

규칙:
- TURN_EVAL: turn 필수 (NOT NULL)
- HOLISTIC_FLOW: turn NULL 필수
- Check Constraint로 강제됨
- details에 score, analysis, intent, rubrics, evaluations 등 포함

백엔드에서 Log만 보기 위한 것

2.12 submissions

PK: id

FK (무결성): (exam_id, participant_id) → exam_participants

FK: spec_id → problem_specs.spec_id

코드/상태: lang, status, code_inline, code_sha256(64), code_bytes, code_loc

타임스탬프: created_at, updated_at(트리거)

2.13 submission_runs

PK: id

UNIQUE: (submission_id, case_index)

FK: submission_id → submissions.id

케이스/그룹/판정/측정: case_index, grp, verdict, time_ms, mem_kb, stdout_bytes, stderr_bytes

시간: created_at

2.14 scores

PK = FK: submission_id → submissions.id

점수: prompt_score, perf_score, correctness_score, total_score

상세: rubric_json

시간: created_at

2.15 admin_audit_logs

PK: id

FK: admin_id → admins.id

내용: action, details(JSONB), created_at

2.16 exam_statistics (추가 테이블 / Statics)

목적: 시험 운영/성과를 일정 주기(버킷)로 스냅샷 저장.
관리자 대시보드(/api/admin/metrics)와 기간 분석에 사용.

PK: id

FK: exam_id → exams.id (ON DELETE CASCADE)

버킷 키: bucket_start(TIMESTAMPTZ), bucket_sec(INT)

UNIQUE(exam_id, bucket_start, bucket_sec) — 동일 시험/버킷 중복 방지

운영 메트릭(실시간):

active_examinees(INT) — 동시 수험자

ws_connections(INT) — WebSocket 연결 수

judge_queue_depth(INT) — 채점 큐 길이

avg_wait_sec(NUMERIC) — 큐 대기 평균

avg_run_time_ms(NUMERIC) — 워커 실행 평균

errors_rate_1m(NUMERIC) — 1분 오류율

제출/성능/정답 요약:

submissions_total(INT) — 누적 제출

submissions_done(INT) — 채점 완료

pass_rate_weighted(NUMERIC) — 가중 통과율(SAMPLE/PUBLIC/PRIVATE 반영)

점수 평균:

avg_prompt_score, avg_perf_score, avg_correctness_score, avg_total_score

토큰 사용:

token_used_total(BIGINT) — 버킷 내 합계

token_used_avg(NUMERIC) — 1인당 평균(선택)

관리: created_at

인덱스: (exam_id, bucket_start DESC)

3) 주요 관계(카디널리티)

admins 1 — N problem_sets, exams, entry_codes, admin_audit_logs

problems 1 — N problem_specs

problems 1 — 0..1 current_spec_id(→ problem_specs)

problem_sets 1 — N problem_set_items — N — 1 problems

exams 1 — N entry_codes, exam_participants, exam_statistics

participants 1 — N exam_participants

problem_specs 1 — N exam_participants (세션 잠금 단위)

exam_participants 1 — N prompt_sessions, submissions

prompt_sessions 1 — N prompt_messages, prompt_evaluations

prompt_messages 1 — 0..1 prompt_evaluations (turn별 평가인 경우만)

submissions 1 — N submission_runs; 1 — 1 scores

4) 무결성/비즈니스 규칙 (요점)

세션 스펙 잠금: exam_participants.spec_id는 대화/제출/평가 전 과정에서 단일 진실 원천.

중복 방지:

exam_participants (exam_id, participant_id) UNIQUE

problem_specs (problem_id, version) UNIQUE

submission_runs (submission_id, case_index) UNIQUE

exam_statistics (exam_id, bucket_start, bucket_sec) UNIQUE

점수 합산: scores.total_score = prompt(40) + perf(30) + correctness(30) 저장(요구사항 기반).

가중 통과율: 그룹 가중치(SAMPLE/PUBLIC/PRIVATE)는 런/판정 집계로 산출 → 통계/상세에 반영.

토큰 한도: exam_participants.token_used 누적; 초과 시 대화 차단.

5) 조회 및 집계 힌트

최근 운영 지표(대시보드):

SELECT * FROM exam_statistics WHERE exam_id = $1 ORDER BY bucket_start DESC LIMIT 1;

기간별 추이:

WHERE exam_id=$1 AND bucket_start BETWEEN $from AND $to ORDER BY bucket_start;

제출 현황:

submissions JOIN scores JOIN 집계(submission_runs)로 성능/통과율/점수 조회.

토큰 사용:

버킷별 token_used_total 또는 prompt_messages.token_count 합으로 검증 가능.

6) 색인(요약)

entry_codes(exam_id)

exam_participants(exam_id, state)

prompt_sessions(exam_id, participant_id)

prompt_messages USING GIN(fts)

submissions(exam_id, participant_id)

submission_runs(submission_id)

exam_statistics(exam_id, bucket_start DESC)

7) 데이터 흐름과 exam_statistics 연결

입장/배정: entry_codes → exam_participants(spec_id)

대화: prompt_sessions/messages (토큰 카운트)

제출/채점: submissions → submission_runs → scores

운영 메트릭 수집: 런타임 카운터(WS/큐/오류율 등) + 위 테이블 집계

스냅샷 저장: exam_statistics 에 버킷 단위 UPSERT

대시보드/보고: 최신 버킷 1개 또는 기간별 조회